<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Extension Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ Comprehensive Extension Diagnostic</h1>
    
    <div class="container">
        <h2>ğŸ“‹ Test Summary</h2>
        <div id="summary" class="status info">Running diagnostics...</div>
        <button onclick="runAllTests()">Run All Tests</button>
    </div>

    <div class="container">
        <h2>ğŸ” Extension Loading Tests</h2>
        
        <div class="test-section">
            <div class="test-title">1. Chrome Runtime Availability</div>
            <div id="chrome-runtime-test" class="status info">Not tested</div>
            <button onclick="testChromeRuntime()">Test Chrome Runtime</button>
        </div>

        <div class="test-section">
            <div class="test-title">2. Extension Manifest</div>
            <div id="manifest-test" class="status info">Not tested</div>
            <button onclick="testManifest()">Test Manifest</button>
        </div>

        <div class="test-section">
            <div class="test-title">3. Content Script Injection</div>
            <div id="content-script-test" class="status info">Not tested</div>
            <button onclick="testContentScript()">Test Content Script</button>
        </div>

        <div class="test-section">
            <div class="test-title">4. Background Script Communication</div>
            <div id="background-test" class="status info">Not tested</div>
            <button onclick="testBackgroundScript()">Test Background Script</button>
        </div>

        <div class="test-section">
            <div class="test-title">5. Service Worker Status</div>
            <div id="service-worker-test" class="status info">Not tested</div>
            <button onclick="testServiceWorker()">Test Service Worker</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ› ï¸ Manual Tests</h2>
        
        <div class="test-section">
            <div class="test-title">Manual Extension Check</div>
            <p>1. Go to <code>chrome://extensions/</code></p>
            <p>2. Look for "BillableAI" in the list</p>
            <p>3. Check if it shows "Enabled" (not "Inactive")</p>
            <p>4. Click "service worker" link to open console</p>
            <p>5. Look for these messages in the console:</p>
            <div class="log">
ğŸ¯ BillableAI: Background script loaded
ğŸ¯ BillableAI: Extension installed/updated
ğŸ¯ BillableAI: Service worker activated
ğŸ¯ BillableAI: Service worker installed
ğŸ¯ BillableAI: Message received: {type: "CONTENT_SCRIPT_LOADED"}
ğŸ¯ BillableAI: Content script loaded on Gmail page
ğŸ¯ BillableAI: Keep-alive ping received
ğŸ¯ BillableAI: Service worker keep-alive ping
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“ Diagnostic Log</h2>
        <div class="log" id="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        let logMessages = [];
        let testResults = {
            chromeRuntime: false,
            manifest: false,
            contentScript: false,
            backgroundScript: false,
            serviceWorker: false
        };
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            const logElement = document.getElementById('log');
            logElement.textContent = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`ğŸ¯ Diagnostic: ${message}`);
        }

        function clearLog() {
            logMessages = [];
            document.getElementById('log').textContent = '';
        }

        function updateStatus(elementId, message, className) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${className}`;
        }

        function updateSummary() {
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.keys(testResults).length;
            const percentage = Math.round((passed / total) * 100);
            
            let summary = `Tests passed: ${passed}/${total} (${percentage}%)`;
            let className = 'info';
            
            if (percentage === 100) {
                summary += ' - âœ… All tests passed!';
                className = 'success';
            } else if (percentage >= 50) {
                summary += ' - âš ï¸ Some tests failed';
                className = 'warning';
            } else {
                summary += ' - âŒ Most tests failed';
                className = 'error';
            }
            
            updateStatus('summary', summary, className);
        }

        function testChromeRuntime() {
            log('ğŸ” Testing Chrome Runtime availability...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                log('âœ… chrome.runtime is available');
                testResults.chromeRuntime = true;
                updateStatus('chrome-runtime-test', 'âœ… Chrome Runtime Available', 'success');
            } else {
                log('âŒ chrome.runtime is NOT available');
                testResults.chromeRuntime = false;
                updateStatus('chrome-runtime-test', 'âŒ Chrome Runtime Not Available', 'error');
            }
            
            updateSummary();
        }

        function testManifest() {
            log('ğŸ“‹ Testing Extension Manifest...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    chrome.runtime.getManifest((manifest) => {
                        log(`âœ… Manifest loaded: ${manifest.name} v${manifest.version}`);
                        log(`ğŸ“‹ Extension ID: ${chrome.runtime.id}`);
                        testResults.manifest = true;
                        updateStatus('manifest-test', `âœ… Manifest: ${manifest.name} v${manifest.version}`, 'success');
                        updateSummary();
                    });
                } catch (error) {
                    log(`âŒ Manifest error: ${error.message}`);
                    testResults.manifest = false;
                    updateStatus('manifest-test', 'âŒ Manifest Error', 'error');
                    updateSummary();
                }
            } else {
                log('âŒ Cannot test manifest - chrome.runtime not available');
                testResults.manifest = false;
                updateStatus('manifest-test', 'âŒ Cannot Test - No Chrome Runtime', 'error');
                updateSummary();
            }
        }

        function testContentScript() {
            log('ğŸ“œ Testing Content Script injection...');
            
            if (window.billableAI) {
                log('âœ… window.billableAI object found');
                log(`ğŸ“‹ Available functions: ${Object.keys(window.billableAI).join(', ')}`);
                testResults.contentScript = true;
                updateStatus('content-script-test', 'âœ… Content Script Injected', 'success');
            } else {
                log('âŒ window.billableAI object not found');
                testResults.contentScript = false;
                updateStatus('content-script-test', 'âŒ Content Script Not Injected', 'error');
            }
            
            updateSummary();
        }

        function testBackgroundScript() {
            log('ğŸ”„ Testing Background Script communication...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    chrome.runtime.sendMessage({ type: 'TEST_COMMUNICATION', data: 'Diagnostic test' }, (response) => {
                        if (chrome.runtime.lastError) {
                            log(`âŒ Background script error: ${chrome.runtime.lastError.message}`);
                            testResults.backgroundScript = false;
                            updateStatus('background-test', 'âŒ Background Script Not Responding', 'error');
                        } else if (response && response.success) {
                            log('âœ… Background script responding');
                            log(`ğŸ“¨ Response: ${JSON.stringify(response)}`);
                            testResults.backgroundScript = true;
                            updateStatus('background-test', 'âœ… Background Script Working', 'success');
                        } else {
                            log('âš ï¸ Background script responded but no success flag');
                            testResults.backgroundScript = false;
                            updateStatus('background-test', 'âš ï¸ Background Script Unclear', 'warning');
                        }
                        updateSummary();
                    });
                } catch (error) {
                    log(`âŒ Background script test error: ${error.message}`);
                    testResults.backgroundScript = false;
                    updateStatus('background-test', 'âŒ Background Script Error', 'error');
                    updateSummary();
                }
            } else {
                log('âŒ Cannot test background script - chrome.runtime not available');
                testResults.backgroundScript = false;
                updateStatus('background-test', 'âŒ Cannot Test - No Chrome Runtime', 'error');
                updateSummary();
            }
        }

        function testServiceWorker() {
            log('âš™ï¸ Testing Service Worker status...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                try {
                    chrome.runtime.sendMessage({ type: 'PING' }, (response) => {
                        if (chrome.runtime.lastError) {
                            log(`âŒ Service worker error: ${chrome.runtime.lastError.message}`);
                            testResults.serviceWorker = false;
                            updateStatus('service-worker-test', 'âŒ Service Worker Not Responding', 'error');
                        } else if (response && response.success) {
                            log('âœ… Service worker responding');
                            testResults.serviceWorker = true;
                            updateStatus('service-worker-test', 'âœ… Service Worker Active', 'success');
                        } else {
                            log('âš ï¸ Service worker responded but no success flag');
                            testResults.serviceWorker = false;
                            updateStatus('service-worker-test', 'âš ï¸ Service Worker Unclear', 'warning');
                        }
                        updateSummary();
                    });
                } catch (error) {
                    log(`âŒ Service worker test error: ${error.message}`);
                    testResults.serviceWorker = false;
                    updateStatus('service-worker-test', 'âŒ Service Worker Error', 'error');
                    updateSummary();
                }
            } else {
                log('âŒ Cannot test service worker - chrome.runtime not available');
                testResults.serviceWorker = false;
                updateStatus('service-worker-test', 'âŒ Cannot Test - No Chrome Runtime', 'error');
                updateSummary();
            }
        }

        function runAllTests() {
            log('ğŸš€ Running all diagnostic tests...');
            clearLog();
            
            // Reset test results
            testResults = {
                chromeRuntime: false,
                manifest: false,
                contentScript: false,
                backgroundScript: false,
                serviceWorker: false
            };
            
            // Run tests with delays to ensure proper execution
            setTimeout(testChromeRuntime, 100);
            setTimeout(testManifest, 200);
            setTimeout(testContentScript, 300);
            setTimeout(testBackgroundScript, 400);
            setTimeout(testServiceWorker, 500);
        }

        // Initialize
        window.addEventListener('load', () => {
            log('ğŸš€ Comprehensive diagnostic page loaded');
            log('ğŸ“ URL: ' + window.location.href);
            log('ğŸŒ User Agent: ' + navigator.userAgent);
            
            // Auto-run tests after a short delay
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html> 