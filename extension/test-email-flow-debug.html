<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Flow Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 10px 0;
        }
        
        .step.success { border-left-color: #28a745; }
        .step.error { border-left-color: #dc3545; }
        .step.warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <h1>üéØ BillableAI - Email Flow Debug Test</h1>
    
    <div class="test-section">
        <h2>üîç Debug Information</h2>
        <div id="debug-info" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìß Simulate Email Send Flow</h2>
        <p>This test simulates the exact flow that happens when you send an email in Gmail:</p>
        
        <div class="step">
            <strong>Step 1:</strong> Simulate email data capture
            <button onclick="simulateEmailCapture()">Simulate Email Capture</button>
        </div>
        
        <div class="step">
            <strong>Step 2:</strong> Store email data via background script
            <button onclick="simulateDataStorage()">Simulate Data Storage</button>
        </div>
        
        <div class="step">
            <strong>Step 3:</strong> Test data retrieval (what Assistant does)
            <button onclick="simulateDataRetrieval()">Simulate Data Retrieval</button>
        </div>
        
        <div class="step">
            <strong>Step 4:</strong> Complete flow test
            <button onclick="simulateCompleteFlow()">Simulate Complete Flow</button>
        </div>
        
        <div id="flow-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üîß Manual Tests</h2>
        <button onclick="testBackgroundScript()">Test Background Script</button>
        <button onclick="testChromeStorage()">Test Chrome Storage</button>
        <button onclick="clearAllData()">Clear All Data</button>
        <button onclick="checkExtensionStatus()">Check Extension Status</button>
        <div id="manual-test-log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìä Data Verification</h2>
        <button onclick="verifyStoredData()">Verify Stored Data</button>
        <button onclick="checkAllStorageLocations()">Check All Storage Locations</button>
        <div id="verification-log" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(logEntry);
        }

        // Debug Information
        function updateDebugInfo() {
            const debugInfo = document.getElementById('debug-info');
            debugInfo.innerHTML = `
                <strong>Extension Status:</strong><br>
                ‚Ä¢ Chrome Extension API: ${typeof chrome !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}<br>
                ‚Ä¢ Chrome Runtime: ${typeof chrome !== 'undefined' && chrome.runtime ? '‚úÖ Available' : '‚ùå Not Available'}<br>
                ‚Ä¢ Chrome Storage: ${typeof chrome !== 'undefined' && chrome.storage ? '‚úÖ Available' : '‚ùå Not Available'}<br>
                ‚Ä¢ Background Script: ${typeof chrome !== 'undefined' && chrome.runtime ? '‚úÖ Available' : '‚ùå Not Available'}<br>
                <br>
                <strong>Current Page:</strong> ${window.location.href}<br>
                <strong>User Agent:</strong> ${navigator.userAgent}<br>
                <strong>Timestamp:</strong> ${new Date().toISOString()}
            `;
        }

        // Step 1: Simulate Email Capture
        async function simulateEmailCapture() {
            const logId = 'flow-log';
            log(logId, 'üìß Step 1: Simulating email data capture...');
            
            const mockEmailData = {
                subject: 'Test Email Subject - Debug Test',
                to: 'recipient@example.com',
                cc: 'cc@example.com',
                bcc: 'bcc@example.com',
                body: 'This is a test email body for debugging the email flow. It contains multiple lines and should be captured properly.',
                timestamp: new Date().toISOString()
            };
            
            const mockTimeSpent = 180000; // 3 minutes
            
            log(logId, `‚úÖ Captured email data:`, mockEmailData);
            log(logId, `‚úÖ Time spent: ${mockTimeSpent}ms (${Math.round(mockTimeSpent / 60000)} minutes)`);
            
            // Store for next step
            window.mockEmailData = mockEmailData;
            window.mockTimeSpent = mockTimeSpent;
            
            log(logId, '‚úÖ Step 1 completed - Email data captured');
        }

        // Step 2: Simulate Data Storage
        async function simulateDataStorage() {
            const logId = 'flow-log';
            log(logId, 'üíæ Step 2: Simulating data storage via background script...');
            
            if (!window.mockEmailData) {
                log(logId, '‚ùå No email data available. Run Step 1 first.');
                return;
            }
            
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        type: 'EMAIL_DATA_STORED',
                        data: {
                            emailData: window.mockEmailData,
                            timeSpent: window.mockTimeSpent,
                            autoProcess: true,
                            timestamp: Date.now()
                        }
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log(logId, `‚úÖ Background script response: ${JSON.stringify(response)}`);
                
                // Verify storage
                const result = await chrome.storage.local.get(['billableAI_emailSummary']);
                log(logId, `‚úÖ Chrome storage verification: ${JSON.stringify(result)}`);
                
                log(logId, '‚úÖ Step 2 completed - Data stored successfully');
                
            } catch (error) {
                log(logId, `‚ùå Step 2 failed: ${error.message}`);
            }
        }

        // Step 3: Simulate Data Retrieval
        async function simulateDataRetrieval() {
            const logId = 'flow-log';
            log(logId, 'üîç Step 3: Simulating data retrieval (Assistant behavior)...');
            
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        type: 'GET_EMAIL_DATA'
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log(logId, `‚úÖ Background script response: ${JSON.stringify(response)}`);
                
                if (response && response.success && response.data) {
                    log(logId, `‚úÖ Found email data:`, response.data);
                    log(logId, `‚úÖ Email subject: ${response.data.emailData?.subject}`);
                    log(logId, `‚úÖ Email to: ${response.data.emailData?.to}`);
                    log(logId, `‚úÖ Time spent: ${response.data.timeSpent}ms`);
                } else {
                    log(logId, `‚ùå No email data found in response`);
                }
                
                log(logId, '‚úÖ Step 3 completed - Data retrieval simulated');
                
            } catch (error) {
                log(logId, `‚ùå Step 3 failed: ${error.message}`);
            }
        }

        // Step 4: Complete Flow
        async function simulateCompleteFlow() {
            const logId = 'flow-log';
            log(logId, 'üîÑ Step 4: Simulating complete email flow...');
            
            try {
                // Step 4a: Capture
                log(logId, 'Step 4a: Capturing email data...');
                await simulateEmailCapture();
                
                // Step 4b: Store
                log(logId, 'Step 4b: Storing email data...');
                await simulateDataStorage();
                
                // Step 4c: Wait a moment
                log(logId, 'Step 4c: Waiting for data to be processed...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 4d: Retrieve
                log(logId, 'Step 4d: Retrieving email data...');
                await simulateDataRetrieval();
                
                // Step 4e: Clear
                log(logId, 'Step 4e: Clearing email data...');
                await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        type: 'CLEAR_EMAIL_DATA'
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log(logId, '‚úÖ Step 4 completed - Complete flow successful!');
                
            } catch (error) {
                log(logId, `‚ùå Step 4 failed: ${error.message}`);
            }
        }

        // Manual Tests
        async function testBackgroundScript() {
            const logId = 'manual-test-log';
            log(logId, 'üîß Testing background script communication...');
            
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        type: 'TEST_COMMUNICATION',
                        data: { test: 'debug-test' }
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log(logId, `‚úÖ Background script responded: ${JSON.stringify(response)}`);
            } catch (error) {
                log(logId, `‚ùå Background script error: ${error.message}`);
            }
        }

        async function testChromeStorage() {
            const logId = 'manual-test-log';
            log(logId, 'üîß Testing chrome.storage.local...');
            
            try {
                // Test write
                await chrome.storage.local.set({ 
                    'debug_test': { 
                        message: 'Debug test data', 
                        timestamp: Date.now() 
                    } 
                });
                log(logId, '‚úÖ Data written to chrome.storage.local');
                
                // Test read
                const result = await chrome.storage.local.get(['debug_test']);
                log(logId, `‚úÖ Data read from chrome.storage.local: ${JSON.stringify(result)}`);
                
                // Clean up
                await chrome.storage.local.remove(['debug_test']);
                log(logId, '‚úÖ Test data cleaned up');
                
            } catch (error) {
                log(logId, `‚ùå Chrome storage error: ${error.message}`);
            }
        }

        async function clearAllData() {
            const logId = 'manual-test-log';
            log(logId, 'üßπ Clearing all stored data...');
            
            try {
                // Clear chrome.storage.local
                await chrome.storage.local.clear();
                log(logId, '‚úÖ Chrome storage cleared');
                
                // Clear localStorage
                localStorage.clear();
                log(logId, '‚úÖ LocalStorage cleared');
                
                // Clear via background script
                await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        type: 'CLEAR_EMAIL_DATA'
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log(logId, '‚úÖ All data cleared successfully');
                
            } catch (error) {
                log(logId, `‚ùå Error clearing data: ${error.message}`);
            }
        }

        async function checkExtensionStatus() {
            const logId = 'manual-test-log';
            log(logId, 'üîç Checking extension status...');
            
            try {
                // Check if extension is installed and accessible
                const manifest = chrome.runtime.getManifest();
                log(logId, `‚úÖ Extension manifest: ${manifest.name} v${manifest.version}`);
                
                // Check permissions
                const permissions = await chrome.permissions.getAll();
                log(logId, `‚úÖ Permissions: ${JSON.stringify(permissions)}`);
                
                // Check storage
                const storage = await chrome.storage.local.get(null);
                log(logId, `‚úÖ Storage keys: ${Object.keys(storage).join(', ')}`);
                
            } catch (error) {
                log(logId, `‚ùå Extension status check failed: ${error.message}`);
            }
        }

        // Data Verification
        async function verifyStoredData() {
            const logId = 'verification-log';
            log(logId, 'üìä Verifying stored data...');
            
            try {
                // Check chrome.storage.local
                const result = await chrome.storage.local.get(['billableAI_emailSummary']);
                log(logId, `‚úÖ Chrome storage data: ${JSON.stringify(result)}`);
                
                // Check localStorage
                const localData = localStorage.getItem('billableAI_emailSummary');
                log(logId, `‚úÖ LocalStorage data: ${localData}`);
                
                // Check via background script
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({
                        type: 'GET_EMAIL_DATA'
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                log(logId, `‚úÖ Background script data: ${JSON.stringify(response)}`);
                
            } catch (error) {
                log(logId, `‚ùå Verification failed: ${error.message}`);
            }
        }

        async function checkAllStorageLocations() {
            const logId = 'verification-log';
            log(logId, 'üìä Checking all storage locations...');
            
            try {
                // Chrome storage
                const chromeData = await chrome.storage.local.get(null);
                log(logId, `‚úÖ Chrome storage keys: ${Object.keys(chromeData).join(', ')}`);
                
                // LocalStorage
                const localKeys = Object.keys(localStorage);
                log(logId, `‚úÖ LocalStorage keys: ${localKeys.join(', ')}`);
                
                // SessionStorage
                const sessionKeys = Object.keys(sessionStorage);
                log(logId, `‚úÖ SessionStorage keys: ${sessionKeys.join(', ')}`);
                
                // Check for BillableAI specific data
                const billableKeys = [...localKeys, ...sessionKeys].filter(key => key.includes('billable'));
                log(logId, `‚úÖ BillableAI related keys: ${billableKeys.join(', ')}`);
                
            } catch (error) {
                log(logId, `‚ùå Storage check failed: ${error.message}`);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéØ BillableAI: Email Flow Debug Test initialized');
            updateDebugInfo();
            
            // Update debug info every 5 seconds
            setInterval(updateDebugInfo, 5000);
        });
    </script>
</body>
</html> 