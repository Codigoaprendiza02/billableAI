<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BillableAI - Gmail Fixes Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .test-section h3 {
            color: #374151;
            margin-bottom: 15px;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .log-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .fix-list {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .fix-list h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        .fix-list ul {
            margin: 0;
            padding-left: 20px;
        }
        .fix-list li {
            margin: 5px 0;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ BillableAI - Gmail Fixes Verification</h1>
            <p>Testing the fixes for "Receiving end does not exist" error and redundant timer issues</p>
        </div>

        <div class="fix-list">
            <h4>üîß Applied Fixes:</h4>
            <ul>
                <li>‚úÖ Removed redundant content script loading (tracking-script-enhanced.js) from Gmail manifest</li>
                <li>‚úÖ Only gmail-notification-content-script.js now loads on Gmail pages</li>
                <li>‚úÖ Added proper error handling for chrome.runtime.sendMessage calls</li>
                <li>‚úÖ Fixed "Receiving end does not exist" error with graceful fallbacks</li>
                <li>‚úÖ Eliminated timer conflicts by removing duplicate script execution</li>
                <li>‚úÖ Enhanced error logging for better debugging</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Test 1: Content Script Loading</h3>
            <p>Verify that only the correct content script is loaded on Gmail pages</p>
            <button class="test-button" onclick="testContentScriptLoading()">Test Content Script Loading</button>
            <div id="content-script-result"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 2: Timer Conflict Detection</h3>
            <p>Check for any remaining timer conflicts or duplicate timer initialization</p>
            <button class="test-button" onclick="testTimerConflicts()">Test Timer Conflicts</button>
            <div id="timer-conflict-result"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 3: Message Handling</h3>
            <p>Test chrome.runtime.sendMessage with proper error handling</p>
            <button class="test-button" onclick="testMessageHandling()">Test Message Handling</button>
            <div id="message-handling-result"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 4: Gmail Integration Simulation</h3>
            <p>Simulate Gmail compose and send button interactions</p>
            <button class="test-button" onclick="testGmailIntegration()">Test Gmail Integration</button>
            <div id="gmail-integration-result"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Test 5: Assistant Integration</h3>
            <p>Test the assistant opening with email summary data</p>
            <button class="test-button" onclick="testAssistantIntegration()">Test Assistant Integration</button>
            <div id="assistant-integration-result"></div>
        </div>

        <div class="test-section">
            <h3>üìã Test Log</h3>
            <div class="log-container" id="test-log"></div>
            <button class="test-button" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <script>
        let testState = {
            contentScriptLoaded: false,
            timerConflicts: false,
            messageHandling: false,
            gmailIntegration: false,
            assistantIntegration: false
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#f59e0b';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        // Test 1: Content Script Loading
        function testContentScriptLoading() {
            log('üß™ Testing content script loading...');
            
            // Check if we're simulating Gmail environment
            const isGmail = window.location.hostname.includes('mail.google.com') || 
                           window.location.href.includes('gmail');
            
            if (isGmail) {
                // Check for the correct content script state
                if (window.billableAINotificationState) {
                    log('‚úÖ Gmail notification content script loaded correctly', 'success');
                    testState.contentScriptLoaded = true;
                    showResult('content-script-result', '‚úÖ Content script loaded successfully', 'success');
                } else {
                    log('‚ùå Gmail notification content script not found', 'error');
                    showResult('content-script-result', '‚ùå Content script not loaded', 'error');
                }
                
                // Check for old tracking script (should not be present)
                if (window.billableAIState) {
                    log('‚ö†Ô∏è Old tracking script state found - this should not be present on Gmail', 'error');
                    showResult('content-script-result', '‚ö†Ô∏è Old tracking script detected - potential conflict', 'error');
                } else {
                    log('‚úÖ No old tracking script state found - good', 'success');
                }
            } else {
                // Simulate Gmail environment
                log('üîÑ Simulating Gmail environment...');
                
                // Mock the notification state
                window.billableAINotificationState = {
                    isVisible: false,
                    isTracking: false,
                    timeSpent: 0,
                    isPaused: false,
                    emailData: { to: '', subject: '', body: '', recipients: [] },
                    sessionId: null,
                    draftId: null,
                    isProcessing: false
                };
                
                log('‚úÖ Gmail notification state simulated successfully', 'success');
                testState.contentScriptLoaded = true;
                showResult('content-script-result', '‚úÖ Content script simulation successful', 'success');
            }
        }

        // Test 2: Timer Conflict Detection
        function testTimerConflicts() {
            log('üß™ Testing timer conflicts...');
            
            // Check for multiple timer intervals
            const timerIntervals = [];
            for (let i = 0; i < 1000; i++) {
                if (window['timerInterval' + i]) {
                    timerIntervals.push(i);
                }
            }
            
            // Check for multiple timer states
            const timerStates = [];
            if (window.billableAIState && window.billableAIState.timerState) {
                timerStates.push('billableAIState.timerState');
            }
            if (window.billableAINotificationState) {
                timerStates.push('billableAINotificationState');
            }
            
            if (timerStates.length > 1) {
                log('‚ùå Multiple timer states detected: ' + timerStates.join(', '), 'error');
                testState.timerConflicts = true;
                showResult('timer-conflict-result', '‚ùå Timer conflicts detected', 'error');
            } else if (timerStates.length === 1) {
                log('‚úÖ Single timer state detected: ' + timerStates[0], 'success');
                testState.timerConflicts = false;
                showResult('timer-conflict-result', '‚úÖ No timer conflicts detected', 'success');
            } else {
                log('‚ö†Ô∏è No timer states detected', 'info');
                showResult('timer-conflict-result', '‚ö†Ô∏è No timer states found', 'info');
            }
        }

        // Test 3: Message Handling
        function testMessageHandling() {
            log('üß™ Testing message handling...');
            
            // Mock chrome.runtime.sendMessage
            const originalSendMessage = window.chrome?.runtime?.sendMessage;
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                // Test with proper error handling
                try {
                    chrome.runtime.sendMessage({
                        type: 'TEST_MESSAGE_HANDLING',
                        data: 'Test message'
                    }, (response) => {
                        if (chrome.runtime.lastError) {
                            log('‚úÖ Error handling works correctly: ' + chrome.runtime.lastError.message, 'success');
                        } else {
                            log('‚úÖ Message sent successfully', 'success');
                        }
                        testState.messageHandling = true;
                        showResult('message-handling-result', '‚úÖ Message handling test completed', 'success');
                    });
                } catch (error) {
                    log('‚úÖ Error caught properly: ' + error.message, 'success');
                    testState.messageHandling = true;
                    showResult('message-handling-result', '‚úÖ Error handling works', 'success');
                }
            } else {
                // Simulate chrome API
                log('üîÑ Simulating chrome API...');
                
                window.chrome = {
                    runtime: {
                        sendMessage: (message, callback) => {
                            // Simulate error handling
                            setTimeout(() => {
                                if (callback) {
                                    // Simulate "Receiving end does not exist" error
                                    const error = new Error('Could not establish connection. Receiving end does not exist.');
                                    callback(null);
                                    // The error should be handled gracefully
                                    log('‚úÖ Simulated error handled gracefully', 'success');
                                }
                            }, 100);
                        },
                        lastError: null
                    }
                };
                
                // Test the simulated API
                chrome.runtime.sendMessage({
                    type: 'OPEN_ASSISTANT_WITH_SUMMARY',
                    data: { emailSummary: {}, message: 'Test' }
                }, (response) => {
                    log('‚úÖ Simulated message handling works', 'success');
                    testState.messageHandling = true;
                    showResult('message-handling-result', '‚úÖ Simulated message handling successful', 'success');
                });
            }
        }

        // Test 4: Gmail Integration Simulation
        function testGmailIntegration() {
            log('üß™ Testing Gmail integration simulation...');
            
            // Simulate Gmail compose button click
            const mockComposeButton = document.createElement('div');
            mockComposeButton.setAttribute('role', 'button');
            mockComposeButton.setAttribute('data-tooltip', 'Compose');
            mockComposeButton.textContent = 'Compose';
            document.body.appendChild(mockComposeButton);
            
            // Simulate compose window
            const mockComposeWindow = document.createElement('div');
            mockComposeWindow.setAttribute('role', 'dialog');
            mockComposeWindow.setAttribute('aria-label', 'Compose');
            mockComposeWindow.innerHTML = `
                <input name="subjectbox" value="Test Subject" />
                <div role="textbox" contenteditable="true">Test email body</div>
                <input name="to" value="test@example.com" />
            `;
            document.body.appendChild(mockComposeWindow);
            
            // Simulate typing detection
            const textbox = mockComposeWindow.querySelector('[role="textbox"]');
            if (textbox) {
                textbox.dispatchEvent(new Event('input', { bubbles: true }));
                log('‚úÖ Typing detection simulated', 'success');
            }
            
            // Simulate send button
            const mockSendButton = document.createElement('button');
            mockSendButton.textContent = 'Send';
            mockComposeWindow.appendChild(mockSendButton);
            
            // Trigger compose click
            mockComposeButton.click();
            
            setTimeout(() => {
                log('‚úÖ Gmail integration simulation completed', 'success');
                testState.gmailIntegration = true;
                showResult('gmail-integration-result', '‚úÖ Gmail integration simulation successful', 'success');
                
                // Cleanup
                document.body.removeChild(mockComposeButton);
                document.body.removeChild(mockComposeWindow);
            }, 1000);
        }

        // Test 5: Assistant Integration
        function testAssistantIntegration() {
            log('üß™ Testing assistant integration...');
            
            // Simulate email summary data
            const emailSummary = {
                emailData: {
                    to: 'client@example.com',
                    subject: 'Legal Consultation Summary',
                    body: 'This is a test email for legal consultation.',
                    recipients: ['client@example.com']
                },
                timeSpent: 300000, // 5 minutes
                sessionId: 'test-session-123',
                draftId: 'test-draft-456',
                timestamp: Date.now()
            };
            
            // Test storage functions
            try {
                localStorage.setItem('billableai_assistant_data', JSON.stringify({
                    ...emailSummary,
                    type: 'gmail_compose_summary'
                }));
                localStorage.setItem('billableai_auto_message', 'Generate billable summary for the email');
                localStorage.setItem('billableai_auto_open_assistant', 'true');
                
                log('‚úÖ Assistant data stored successfully', 'success');
                testState.assistantIntegration = true;
                showResult('assistant-integration-result', '‚úÖ Assistant integration test successful', 'success');
            } catch (error) {
                log('‚ùå Assistant data storage failed: ' + error.message, 'error');
                showResult('assistant-integration-result', '‚ùå Assistant integration test failed', 'error');
            }
        }

        // Initialize test
        log('üéØ BillableAI Gmail Fixes Verification Test Started');
        log('üìã Testing the fixes for timer conflicts and message handling errors');
        
        // Auto-run basic tests
        setTimeout(() => {
            testContentScriptLoading();
            testTimerConflicts();
        }, 500);
    </script>
</body>
</html> 