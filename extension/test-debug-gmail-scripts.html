<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BillableAI - Gmail Script Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }
        .debug-section h3 {
            color: #374151;
            margin-bottom: 15px;
        }
        .debug-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .debug-button:hover {
            background: #2563eb;
        }
        .log-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ BillableAI - Gmail Script Debug</h1>
            <p>Debugging script conflicts and timer issues on Gmail</p>
        </div>

        <div class="debug-section">
            <h3>üîç Script Detection</h3>
            <p>Check which scripts are currently running and their states</p>
            <button class="debug-button" onclick="detectScripts()">Detect Running Scripts</button>
            <button class="debug-button" onclick="checkTimerStates()">Check Timer States</button>
            <button class="debug-button" onclick="checkGlobalStates()">Check Global States</button>
            <div id="script-detection-result"></div>
        </div>

        <div class="debug-section">
            <h3>üß™ Gmail Simulation</h3>
            <p>Simulate Gmail environment and test script behavior</p>
            <button class="debug-button" onclick="simulateGmail()">Simulate Gmail</button>
            <button class="debug-button" onclick="testComposeButton()">Test Compose Button</button>
            <button class="debug-button" onclick="testTimerStart()">Test Timer Start</button>
            <div id="gmail-simulation-result"></div>
        </div>

        <div class="debug-section">
            <h3>üîß Fix Verification</h3>
            <p>Verify that the fixes are working correctly</p>
            <button class="debug-button" onclick="verifyFixes()">Verify Fixes</button>
            <button class="debug-button" onclick="testMessageHandling()">Test Message Handling</button>
            <div id="fix-verification-result"></div>
        </div>

        <div class="debug-section">
            <h3>üìã Debug Log</h3>
            <div class="log-container" id="debug-log"></div>
            <button class="debug-button" onclick="clearDebugLog()">Clear Log</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logContainer = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : type === 'warning' ? '#f59e0b' : '#f9fafb';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearDebugLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        // Detect which scripts are running
        function detectScripts() {
            log('üîç Detecting running scripts...');
            
            const scripts = [];
            
            // Check for different script states
            if (window.billableAIState) {
                scripts.push('billableAIState (old tracking script)');
                log('‚ö†Ô∏è Found billableAIState - OLD SCRIPT DETECTED', 'warning');
            }
            
            if (window.billableAINotificationState) {
                scripts.push('billableAINotificationState (new notification script)');
                log('‚úÖ Found billableAINotificationState - NEW SCRIPT DETECTED', 'success');
            }
            
            // Check for other potential script states
            if (window.billableAI) {
                scripts.push('billableAI (global functions)');
                log('‚ÑπÔ∏è Found billableAI global functions', 'info');
            }
            
            if (scripts.length === 0) {
                log('‚ùå No BillableAI scripts detected', 'error');
                showResult('script-detection-result', '‚ùå No scripts detected', 'error');
            } else if (scripts.length === 1) {
                log('‚úÖ Single script detected: ' + scripts[0], 'success');
                showResult('script-detection-result', '‚úÖ Single script: ' + scripts[0], 'success');
            } else {
                log('‚ùå Multiple scripts detected: ' + scripts.join(', '), 'error');
                showResult('script-detection-result', '‚ùå Multiple scripts: ' + scripts.join(', '), 'error');
            }
        }

        // Check timer states
        function checkTimerStates() {
            log('‚è±Ô∏è Checking timer states...');
            
            const timerStates = [];
            
            if (window.billableAIState && window.billableAIState.timerState) {
                timerStates.push('billableAIState.timerState');
                log('‚ö†Ô∏è Found old timer state', 'warning');
            }
            
            if (window.billableAINotificationState) {
                timerStates.push('billableAINotificationState');
                log('‚úÖ Found new timer state', 'success');
            }
            
            // Check for timer intervals
            const intervals = [];
            for (let i = 0; i < 1000; i++) {
                if (window['timerInterval' + i] || window['timerIntervalRef']) {
                    intervals.push(i);
                }
            }
            
            if (intervals.length > 0) {
                log('‚ö†Ô∏è Found timer intervals: ' + intervals.join(', '), 'warning');
            }
            
            if (timerStates.length === 0) {
                log('‚ÑπÔ∏è No timer states found', 'info');
                showResult('script-detection-result', '‚ÑπÔ∏è No timer states found', 'info');
            } else if (timerStates.length === 1) {
                log('‚úÖ Single timer state: ' + timerStates[0], 'success');
                showResult('script-detection-result', '‚úÖ Single timer: ' + timerStates[0], 'success');
            } else {
                log('‚ùå Multiple timer states: ' + timerStates.join(', '), 'error');
                showResult('script-detection-result', '‚ùå Multiple timers: ' + timerStates.join(', '), 'error');
            }
        }

        // Check global states
        function checkGlobalStates() {
            log('üåê Checking global states...');
            
            const states = [];
            
            // Check for various global state objects
            Object.keys(window).forEach(key => {
                if (key.includes('billable') || key.includes('Billable')) {
                    states.push(key);
                }
            });
            
            if (states.length === 0) {
                log('‚ÑπÔ∏è No BillableAI global states found', 'info');
            } else {
                log('üìã Found global states: ' + states.join(', '), 'info');
                states.forEach(state => {
                    log('  - ' + state + ': ' + typeof window[state], 'info');
                });
            }
            
            showResult('script-detection-result', 'Found ' + states.length + ' global states', states.length === 1 ? 'success' : 'warning');
        }

        // Simulate Gmail environment
        function simulateGmail() {
            log('üîÑ Simulating Gmail environment...');
            
            // Mock Gmail notification state
            if (!window.billableAINotificationState) {
                window.billableAINotificationState = {
                    isVisible: false,
                    isTracking: false,
                    timeSpent: 0,
                    isPaused: false,
                    emailData: { to: '', subject: '', body: '', recipients: [] },
                    sessionId: null,
                    draftId: null,
                    isProcessing: false
                };
                log('‚úÖ Created mock billableAINotificationState', 'success');
            }
            
            // Mock Gmail compose button
            const mockComposeButton = document.createElement('div');
            mockComposeButton.setAttribute('role', 'button');
            mockComposeButton.setAttribute('data-tooltip', 'Compose');
            mockComposeButton.textContent = 'Compose';
            document.body.appendChild(mockComposeButton);
            
            log('‚úÖ Gmail environment simulated', 'success');
            showResult('gmail-simulation-result', '‚úÖ Gmail environment simulated', 'success');
        }

        // Test compose button
        function testComposeButton() {
            log('üß™ Testing compose button...');
            
            const composeButton = document.querySelector('[role="button"][data-tooltip="Compose"]');
            if (composeButton) {
                composeButton.click();
                log('‚úÖ Compose button clicked', 'success');
                showResult('gmail-simulation-result', '‚úÖ Compose button test successful', 'success');
            } else {
                log('‚ùå Compose button not found', 'error');
                showResult('gmail-simulation-result', '‚ùå Compose button not found', 'error');
            }
        }

        // Test timer start
        function testTimerStart() {
            log('‚è±Ô∏è Testing timer start...');
            
            if (window.billableAINotificationState) {
                // Simulate timer start
                window.billableAINotificationState.isTracking = true;
                window.billableAINotificationState.timeSpent = 0;
                log('‚úÖ Timer started in notification state', 'success');
                showResult('gmail-simulation-result', '‚úÖ Timer start test successful', 'success');
            } else {
                log('‚ùå No notification state found', 'error');
                showResult('gmail-simulation-result', '‚ùå No notification state found', 'error');
            }
        }

        // Verify fixes
        function verifyFixes() {
            log('üîß Verifying fixes...');
            
            let issues = 0;
            
            // Check for old script
            if (window.billableAIState) {
                log('‚ùå Old script still present', 'error');
                issues++;
            } else {
                log('‚úÖ Old script not present', 'success');
            }
            
            // Check for new script
            if (window.billableAINotificationState) {
                log('‚úÖ New script present', 'success');
            } else {
                log('‚ùå New script not present', 'error');
                issues++;
            }
            
            // Check for multiple timers
            const timerStates = [];
            if (window.billableAIState && window.billableAIState.timerState) timerStates.push('old');
            if (window.billableAINotificationState) timerStates.push('new');
            
            if (timerStates.length > 1) {
                log('‚ùå Multiple timers detected', 'error');
                issues++;
            } else if (timerStates.length === 1) {
                log('‚úÖ Single timer detected', 'success');
            } else {
                log('‚ö†Ô∏è No timers detected', 'warning');
            }
            
            if (issues === 0) {
                showResult('fix-verification-result', '‚úÖ All fixes verified successfully', 'success');
            } else {
                showResult('fix-verification-result', '‚ùå ' + issues + ' issues found', 'error');
            }
        }

        // Test message handling
        function testMessageHandling() {
            log('üì® Testing message handling...');
            
            // Mock chrome API
            if (typeof chrome === 'undefined') {
                window.chrome = {
                    runtime: {
                        sendMessage: (message, callback) => {
                            setTimeout(() => {
                                if (callback) {
                                    // Simulate "Receiving end does not exist" error
                                    callback(null);
                                }
                            }, 100);
                        },
                        lastError: {
                            message: 'Could not establish connection. Receiving end does not exist.'
                        }
                    }
                };
                log('‚úÖ Chrome API mocked', 'success');
            }
            
            // Test message sending
            try {
                chrome.runtime.sendMessage({
                    type: 'TEST_MESSAGE',
                    data: 'test'
                }, (response) => {
                    if (chrome.runtime.lastError) {
                        log('‚úÖ Error handling works: ' + chrome.runtime.lastError.message, 'success');
                        showResult('fix-verification-result', '‚úÖ Message handling test successful', 'success');
                    } else {
                        log('‚úÖ Message sent successfully', 'success');
                        showResult('fix-verification-result', '‚úÖ Message handling test successful', 'success');
                    }
                });
            } catch (error) {
                log('‚úÖ Error caught properly: ' + error.message, 'success');
                showResult('fix-verification-result', '‚úÖ Message handling test successful', 'success');
            }
        }

        // Initialize debug
        log('üéØ BillableAI Gmail Script Debug Started');
        log('üîç Ready to detect script conflicts and timer issues');
        
        // Auto-run basic detection
        setTimeout(() => {
            detectScripts();
            checkTimerStates();
        }, 500);
    </script>
</body>
</html> 